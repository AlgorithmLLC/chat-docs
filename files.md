### Отправка/получение файлов

Данный документ описывает логику и сценарий работы при отправке получении файлов.

1. [Отправка файлов](/files.md#Отправка-файлов)
2. [Скачивание файлов](/files.md#Скачивание-файлов)

#### Отправка файлов
Отправка сообщений с файлами происходит в три этапа.

1. Шифрование файла на клиенте
2. Отправка шифрованного тела файла на сервер
3. Отправка сообщения с метаданными зашифрованного файла собеседнику

На изображении ниже изображено меню выбора вложений
<br /><img src='/blob/files/1file_menu.png' width=250  />

На следующих изображениях соответственно процесс шифрования и загрузки зашифрованного тела файла на сервер:
<br /><img src='/blob/files/2file_crypt.png' width=250  />
<img src='/blob/files/3file_transfer.png' width=250  />

Для отображения процесса шифрования и процесса отправки использовать соответственно:
<br /><img src='/blob/files/progress_circular_indeterminate.gif'  />
<img src='/blob/files/progress_circular_determinate.gif' />

Обработанный и загруженный на сервер файл отображается в доке следующим образом:
<br /><img src='/blob/files/4file_ready.png' width=250  />

Если количество элементов в доке больше ширины экрана, то работает горизонтальная прокрутка жестами
<br /><img src='/blob/files/5file_full_dock.png' width=250  />

При клике на крестик в углу прямоугольника, изображающего вложение, удалить вложение из сообщения и отправить на сервер запрос на удаление файла.

#### Скачивание файлов
Отправленные/полученные файлы:
<br /><img src='/blob/files/7file_sent2.png' width=250  />
<img src='/blob/files/8file_received.png' width=250  />

Отправленные и полученные файлы отображаются одинаково и доступны для скачивания.

1. Каждый файл можно скачать отдельно. Если файл еще не был скачан на этом устройстве, то при клике на файл открывается файловый менеджер для выбора места, куда нужно сохранить файл. После выбора иконка файла меняется на иконку процесса загрузки(далее расшифровки). Загрузка/расшифровка осуществляется фоновой службой. После успешной загрузки иконка файла меняется на галочку (см. изображение ниже). Если файл уже был скачан и рядом с ним стоит иконка "галочка", то при клике на файл открывается попап меню с выбором "Открыть|Скачать заново".
2. Нажав на ссылку "СОХРАНИТЬ ВСЕ", осуществляется процесс последовательной загрузки/расшифровки/сохранения всех файлов из сообщения.

Процесс получения файлов:
<br /><img src='/blob/files/10file_receiving.png' width=250  />
